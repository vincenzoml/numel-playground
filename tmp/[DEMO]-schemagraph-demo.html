<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SchemaGraph Demo</title>

	<!-- Combined CSS -->
	<link rel="stylesheet" href="schemagraph.css">

	<style>
		/* Demo-specific styles */
		html, body {
			margin: 0;
			padding: 0;
			height: 100%;
			overflow: hidden;
		}

		.demo-container {
			display: flex;
			flex-direction: column;
			height: 100vh;
			background: var(--sg-bg-primary);
		}

		.demo-header {
			padding: 12px 20px;
			background: var(--sg-bg-secondary);
			border-bottom: 1px solid var(--sg-border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-shrink: 0;
		}

		.demo-title {
			font-family: 'Segoe UI', sans-serif;
			font-size: 18px;
			font-weight: 600;
			color: var(--sg-text-primary);
			margin: 0;
		}

		.demo-subtitle {
			font-size: 11px;
			color: var(--sg-text-tertiary);
			margin-left: 12px;
		}

		.demo-actions {
			display: flex;
			gap: 8px;
		}

		.demo-btn {
			background: var(--sg-bg-tertiary);
			color: var(--sg-text-primary);
			border: 1px solid var(--sg-border-color);
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			transition: all 0.15s ease;
		}

		.demo-btn:hover {
			background: var(--sg-accent-blue);
			border-color: var(--sg-accent-blue);
		}

		.demo-btn-primary {
			background: var(--sg-accent-blue);
			border-color: var(--sg-accent-blue);
		}

		.demo-canvas-wrapper {
			flex: 1;
			position: relative;
			overflow: hidden;
		}

		#schemaGraphCanvas {
			width: 100%;
			height: 100%;
			display: block;
		}

		.demo-info {
			position: absolute;
			bottom: 80px;
			left: 20px;
			background: var(--sg-bg-secondary);
			border: 1px solid var(--sg-border-color);
			border-radius: 6px;
			padding: 12px 16px;
			font-family: 'Segoe UI', sans-serif;
			font-size: 11px;
			color: var(--sg-text-secondary);
			max-width: 300px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.4);
			z-index: 50;
		}

		.demo-info h4 {
			margin: 0 0 8px 0;
			color: var(--sg-text-primary);
			font-size: 12px;
		}

		.demo-info ul {
			margin: 0;
			padding-left: 16px;
		}

		.demo-info li {
			margin: 4px 0;
		}

		.demo-info kbd {
			background: var(--sg-bg-tertiary);
			padding: 2px 6px;
			border-radius: 3px;
			font-family: monospace;
			font-size: 10px;
		}
	</style>
</head>
<body>
	<div class="demo-container sg-app" data-theme="dark">
		<header class="demo-header">
			<div style="display: flex; align-items: center;">
				<h1 class="demo-title">SchemaGraph Demo</h1>
				<span class="demo-subtitle">Node-based graph visualization</span>
			</div>
			<div class="demo-actions">
				<button class="demo-btn" onclick="addSampleNodes()">Add Sample Nodes</button>
				<button class="demo-btn" onclick="clearGraph()">Clear Graph</button>
				<button class="demo-btn" onclick="cycleTheme()">Toggle Theme</button>
				<button class="demo-btn demo-btn-primary" onclick="showInfo()">Info</button>
			</div>
		</header>

		<div class="demo-canvas-wrapper sg-canvas-container">
			<canvas id="schemaGraphCanvas"></canvas>

			<div class="demo-info" id="demoInfo">
				<h4>Quick Controls</h4>
				<ul>
					<li><kbd>Right-click</kbd> - Context menu (add nodes)</li>
					<li><kbd>Click + Drag</kbd> - Move nodes</li>
					<li><kbd>Scroll</kbd> - Zoom in/out</li>
					<li><kbd>Middle-click + Drag</kbd> - Pan canvas</li>
					<li><kbd>Double-click</kbd> - Edit node fields</li>
					<li><kbd>Delete</kbd> - Remove selected node</li>
					<li><kbd>Ctrl+A</kbd> - Select all</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- Load scripts in correct order -->
	<script src="schemagraph-core.js"></script>
	<script src="schemagraph-workflow.js"></script>
	<script src="schemagraph-graph.js"></script>
	<script src="schemagraph-extensions.js"></script>
	<script src="schemagraph-controllers.js"></script>
	<script src="schemagraph-drawing.js"></script>
	<script src="schemagraph-app.js"></script>
	<script src="schemagraph-bundle.js"></script>

	<script>
		// ====================================================================
		// DEMO INITIALIZATION
		// ====================================================================

		let app;
		let currentThemeIndex = 0;
		const themes = ['dark', 'light', 'ocean'];

		// Initialize when DOM is ready
		document.addEventListener('DOMContentLoaded', function() {
			// Canvas id
			const canvasId = 'schemaGraphCanvas';

			// Set canvas size
			resizeCanvas();
			window.addEventListener('resize', resizeCanvas);

			// Create SchemaGraph application
			// Use SchemaGraphApp directly (also works: SchemaGraph.create if bundle loaded)
			if (typeof SchemaGraph === 'object' && typeof SchemaGraph.create === 'function') {
				app = SchemaGraph.create(canvasId, { theme: 'dark', showGrid: true });
			} else {
				// Fallback to direct instantiation
				app = new SchemaGraphApp(canvasId, { theme: 'dark', showGrid: true });
			}

			// Register sample node types
			registerSampleNodeTypes();

			// Add some initial nodes
			addSampleNodes();

			// Log info
			SchemaGraph.logInfo();

			console.log('SchemaGraph demo initialized!');
			console.log('API available via: app.api or window.app');

			// Make app globally accessible for debugging
			window.app = app;
		});

		function resizeCanvas() {
			const canvas = document.getElementById('schemaGraphCanvas');
			const wrapper = canvas.parentElement;
			canvas.width = wrapper.clientWidth;
			canvas.height = wrapper.clientHeight;
			if (app) app.draw();
		}

		// ====================================================================
		// SAMPLE NODE TYPES
		// ====================================================================

		function registerSampleNodeTypes() {
			// Input node
			app.graph.registerNodeType('demo.Input', {
				title: 'Input',
				color: '#4a9eff',
				inputs: [],
				outputs: [
					{ name: 'output', type: 'any', label: 'Output' }
				],
				fields: [
					{ name: 'value', type: 'string', label: 'Value', default: '' }
				]
			});

			// Process node
			app.graph.registerNodeType('demo.Process', {
				title: 'Process',
				color: '#50c878',
				inputs: [
					{ name: 'input', type: 'any', label: 'Input' }
				],
				outputs: [
					{ name: 'output', type: 'any', label: 'Output' }
				],
				fields: [
					{ name: 'operation', type: 'string', label: 'Operation', default: 'transform' }
				]
			});

			// Output node
			app.graph.registerNodeType('demo.Output', {
				title: 'Output',
				color: '#ff6b6b',
				inputs: [
					{ name: 'input', type: 'any', label: 'Input' }
				],
				outputs: [],
				fields: [
					{ name: 'format', type: 'string', label: 'Format', default: 'json' }
				]
			});

			// Conditional node
			app.graph.registerNodeType('demo.Condition', {
				title: 'Condition',
				color: '#ffd700',
				inputs: [
					{ name: 'input', type: 'any', label: 'Input' }
				],
				outputs: [
					{ name: 'true', type: 'any', label: 'True' },
					{ name: 'false', type: 'any', label: 'False' }
				],
				fields: [
					{ name: 'condition', type: 'string', label: 'Condition', default: 'value > 0' }
				]
			});

			// Merge node
			app.graph.registerNodeType('demo.Merge', {
				title: 'Merge',
				color: '#9370db',
				inputs: [
					{ name: 'input1', type: 'any', label: 'Input 1' },
					{ name: 'input2', type: 'any', label: 'Input 2' }
				],
				outputs: [
					{ name: 'output', type: 'any', label: 'Output' }
				],
				fields: [
					{ name: 'mode', type: 'string', label: 'Mode', default: 'concat' }
				]
			});

			console.log('Sample node types registered');
		}

		// ====================================================================
		// DEMO FUNCTIONS
		// ====================================================================

		function addSampleNodes() {
			// Clear existing nodes first
			clearGraph();

			// Create sample workflow
			const input1 = app.graph.createNode('demo.Input', 100, 100, { value: 'Hello' });
			const input2 = app.graph.createNode('demo.Input', 100, 300, { value: 'World' });
			const merge = app.graph.createNode('demo.Merge', 350, 200, { mode: 'concat' });
			const process = app.graph.createNode('demo.Process', 600, 200, { operation: 'uppercase' });
			const condition = app.graph.createNode('demo.Condition', 850, 200, { condition: 'length > 5' });
			const output1 = app.graph.createNode('demo.Output', 1100, 100, { format: 'json' });
			const output2 = app.graph.createNode('demo.Output', 1100, 300, { format: 'text' });

			// Create links
			app.graph.createLink(input1, 'output', merge, 'input1');
			app.graph.createLink(input2, 'output', merge, 'input2');
			app.graph.createLink(merge, 'output', process, 'input');
			app.graph.createLink(process, 'output', condition, 'input');
			app.graph.createLink(condition, 'true', output1, 'input');
			app.graph.createLink(condition, 'false', output2, 'input');

			// Center the view
			setTimeout(() => {
				app.centerView();
			}, 100);

			console.log('Sample nodes added');
		}

		function clearGraph() {
			if (app) {
				// Use the API's graph.clear() method for proper cleanup
				app.api.graph.clear();
				console.log('Graph cleared');
			}
		}

		function cycleTheme() {
			currentThemeIndex = (currentThemeIndex + 1) % themes.length;
			const theme = themes[currentThemeIndex];
			document.querySelector('.demo-container').setAttribute('data-theme', theme);
			if (app) {
				app.setTheme(theme);
			}
			console.log('Theme changed to:', theme);
		}

		function showInfo() {
			const info = document.getElementById('demoInfo');
			info.style.display = info.style.display === 'none' ? 'block' : 'none';
		}

		// ====================================================================
		// KEYBOARD SHORTCUTS
		// ====================================================================

		document.addEventListener('keydown', function(e) {
			// Toggle info with 'I' key
			if (e.key === 'i' && !e.ctrlKey && !e.metaKey) {
				const activeElement = document.activeElement;
				if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
					showInfo();
				}
			}

			// Add node with 'N' key
			if (e.key === 'n' && !e.ctrlKey && !e.metaKey) {
				const activeElement = document.activeElement;
				if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
					const types = ['demo.Input', 'demo.Process', 'demo.Output', 'demo.Condition', 'demo.Merge'];
					const randomType = types[Math.floor(Math.random() * types.length)];
					const x = 200 + Math.random() * 400;
					const y = 100 + Math.random() * 300;
					app.graph.createNode(randomType, x, y);
					app.draw();
				}
			}
		});
	</script>
</body>
</html>
